// -*-C++-*-
#ifndef FUNHPC_REXEC
#define FUNHPC_REXEC

#include <cxx/task>
#include <qthread/thread>

#include <type_traits>

namespace funhpc {
std::size_t rank();
std::size_t size();

typedef cxx::task<void> task_t;
void enqueue_task(std::size_t dest, task_t &&t);

// Remote execution
template <typename F, typename... Args>
void rexec(std::size_t dest, F &&f, Args &&... args) {
  if (dest == rank())
    return qthread::thread(std::forward<F>(f), std::forward<Args>(args)...)
        .detach();
  task_t::register_type<F, Args...>();
  enqueue_task(dest, task_t(std::forward<F>(f), std::forward<Args>(args)...));
}
}

#define FUNHPC_REXEC_DONE
#endif // #ifdef FUNHPC_REXEC
#ifndef FUNHPC_REXEC_DONE
#error "Cyclic include dependency"
#endif
