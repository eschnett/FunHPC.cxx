#! /bin/bash
#SBATCH -A TG-ASC120003
#SBATCH -p development
#SBATCH -t 0:20:0
#SBATCH -N 1 -n 2
#SBATCH -J mpi-rpc
#SBATCH --mail-type=ALL
#SBATCH -o /work/00507/eschnett/src/cc/mpi-rpc/matbench.out
#SBATCH -e /work/00507/eschnett/src/cc/mpi-rpc/matbench.err

source /work/00507/eschnett/SIMFACTORY/boost-1_55_0/env.sh
source /work/00507/eschnett/SIMFACTORY/gperftools-2.1/env.sh
source /work/00507/eschnett/SIMFACTORY/hwloc-1.8/env.sh
source /work/00507/eschnett/SIMFACTORY/llvm-3.4/env.sh
source /work/00507/eschnett/SIMFACTORY/openmpi-1.7.3/env.sh
source /work/00507/eschnett/SIMFACTORY/qthreads-1.10/env.sh

cd /work/00507/eschnett/src/cc/mpi-rpc

# TODO:
# 1. test performance effect of guard pages

mpirun -np 1 -x QTHREAD_NUM_SHEPHERDS=1 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=16 ./bench
mpirun -np 1 -x QTHREAD_NUM_SHEPHERDS=2 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=8 ./bench
mpirun -np 1 -x QTHREAD_NUM_SHEPHERDS=16 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=1 ./bench
mpirun -np 2 -x QTHREAD_NUM_SHEPHERDS=1 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=8 ./bench
mpirun -np 2 -x QTHREAD_NUM_SHEPHERDS=8 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=1 ./bench

# -x CPUPROFILE=matbench.prof
mpirun -np 1 -x QTHREAD_NUM_SHEPHERDS=1 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=16 ./matbench
mpirun -np 1 -x QTHREAD_NUM_SHEPHERDS=2 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=8 ./matbench
mpirun -np 1 -x QTHREAD_NUM_SHEPHERDS=16 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=1 ./matbench
mpirun -np 2 -x QTHREAD_NUM_SHEPHERDS=1 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=8 ./matbench
mpirun -np 2 -x QTHREAD_NUM_SHEPHERDS=8 -x QTHREAD_NUM_WORKERS_PER_SHEPHERD=1 ./matbench
